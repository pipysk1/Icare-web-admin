(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{1536:function(e,t,a){"use strict";a.r(t),a.d(t,"default",(function(){return P}));var s=a(19),r=a.n(s),n=a(88),i=a.n(n),o=a(400),c=a.n(o),l=a(97),h=a(99),u=a(92),p=a.n(u),m=a(93),y=a(279),d=a(108),b=a(226),k=a(438);const _=0,C=5;class P extends i.a.PureComponent{constructor(e){super(e),r()(this,"_collectRecoveryKeyNode",e=>{this._recoveryKeyNode=e}),r()(this,"_onCopyClick",()=>{Object(b.b)(this._recoveryKeyNode)&&this.setState({copied:!0,phase:3})}),r()(this,"_onDownloadClick",()=>{const e=new Blob([this._keyBackupInfo.recovery_key],{type:"text/plain;charset=us-ascii"});c.a.saveAs(e,"security-key.txt"),this.setState({downloaded:!0,phase:3})}),r()(this,"_createBackup",async()=>{const{secureSecretStorage:e}=this.state;let t;this.setState({phase:4,error:null});try{e?await Object(y.b)(async()=>{t=await h.a.get().prepareKeyBackupVersion(null,{secureSecretStorage:!0}),t=await h.a.get().createKeyBackupVersion(t)}):t=await h.a.get().createKeyBackupVersion(this._keyBackupInfo),await h.a.get().scheduleAllGroupSessionsForBackup(),this.setState({phase:C})}catch(e){console.error("Error creating key backup",e),t&&h.a.get().deleteKeyBackupVersion(t.version),this.setState({error:e})}}),r()(this,"_onCancel",()=>{this.props.onFinished(!1)}),r()(this,"_onDone",()=>{this.props.onFinished(!0)}),r()(this,"_onOptOutClick",()=>{this.setState({phase:6})}),r()(this,"_onSetUpClick",()=>{this.setState({phase:_})}),r()(this,"_onSkipPassPhraseClick",async()=>{this._keyBackupInfo=await h.a.get().prepareKeyBackupVersion(),this.setState({copied:!1,downloaded:!1,phase:2})}),r()(this,"_onPassPhraseNextClick",async e=>{if(e.preventDefault(),this._passphraseField.current){if(await this._passphraseField.current.validate({allowEmpty:!1}),!this._passphraseField.current.state.valid)return this._passphraseField.current.focus(),void this._passphraseField.current.validate({allowEmpty:!1,focused:!0});this.setState({phase:1})}}),r()(this,"_onPassPhraseConfirmNextClick",async e=>{e.preventDefault(),this.state.passPhrase===this.state.passPhraseConfirm&&(this._keyBackupInfo=await h.a.get().prepareKeyBackupVersion(this.state.passPhrase),this.setState({copied:!1,downloaded:!1,phase:2}))}),r()(this,"_onSetAgainClick",()=>{this.setState({passPhrase:"",passPhraseValid:!1,passPhraseConfirm:"",phase:_})}),r()(this,"_onKeepItSafeBackClick",()=>{this.setState({phase:2})}),r()(this,"_onPassPhraseValidate",e=>{this.setState({passPhraseValid:e.valid})}),r()(this,"_onPassPhraseChange",e=>{this.setState({passPhrase:e.target.value})}),r()(this,"_onPassPhraseConfirmChange",e=>{this.setState({passPhraseConfirm:e.target.value})}),this._recoveryKeyNode=null,this._keyBackupInfo=null,this.state={secureSecretStorage:null,phase:_,passPhrase:"",passPhraseValid:!1,passPhraseConfirm:"",copied:!1,downloaded:!1},this._passphraseField=Object(n.createRef)()}async componentDidMount(){const e=h.a.get(),t=await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing");this.setState({secureSecretStorage:t}),t&&(this.setState({phase:4}),this._createBackup())}_renderPhasePassPhrase(){const e=l.getComponent("views.elements.DialogButtons");return i.a.createElement("form",{onSubmit:this._onPassPhraseNextClick},i.a.createElement("p",null,Object(m.a)("<b>Warning</b>: You should only set up key backup from a trusted computer.",{},{b:e=>i.a.createElement("b",null,e)})),i.a.createElement("p",null,Object(m.a)("We'll store an encrypted copy of your keys on our server. Secure your backup with a Security Phrase.")),i.a.createElement("p",null,Object(m.a)("For maximum security, this should be different from your account password.")),i.a.createElement("div",{className:"mx_CreateKeyBackupDialog_primaryContainer"},i.a.createElement("div",{className:"mx_CreateKeyBackupDialog_passPhraseContainer"},i.a.createElement(k.a,{className:"mx_CreateKeyBackupDialog_passPhraseInput",onChange:this._onPassPhraseChange,minScore:4,value:this.state.passPhrase,onValidate:this._onPassPhraseValidate,fieldRef:this._passphraseField,autoFocus:!0,label:Object(m.b)("Enter a Security Phrase"),labelEnterPassword:Object(m.b)("Enter a Security Phrase"),labelStrongPassword:Object(m.b)("Great! This Security Phrase looks strong enough."),labelAllowedButUnsafe:Object(m.b)("Great! This Security Phrase looks strong enough.")}))),i.a.createElement(e,{primaryButton:Object(m.a)("Next"),onPrimaryButtonClick:this._onPassPhraseNextClick,hasCancel:!1,disabled:!this.state.passPhraseValid}),i.a.createElement("details",null,i.a.createElement("summary",null,Object(m.a)("Advanced")),i.a.createElement(d.a,{kind:"primary",onClick:this._onSkipPassPhraseClick},Object(m.a)("Set up with a Security Key"))))}_renderPhasePassPhraseConfirm(){const e=l.getComponent("elements.AccessibleButton");let t,a;this.state.passPhraseConfirm===this.state.passPhrase?(t=Object(m.a)("That matches!"),a=Object(m.a)("Use a different passphrase?")):this.state.passPhrase.startsWith(this.state.passPhraseConfirm)||(t=Object(m.a)("That doesn't match."),a=Object(m.a)("Go back to set it again."));let s=null;t&&(s=i.a.createElement("div",{className:"mx_CreateKeyBackupDialog_passPhraseMatch"},i.a.createElement("div",null,t),i.a.createElement("div",null,i.a.createElement(e,{element:"span",className:"mx_linkButton",onClick:this._onSetAgainClick},a))));const r=l.getComponent("views.elements.DialogButtons");return i.a.createElement("form",{onSubmit:this._onPassPhraseConfirmNextClick},i.a.createElement("p",null,Object(m.a)("Enter your Security Phrase a second time to confirm it.")),i.a.createElement("div",{className:"mx_CreateKeyBackupDialog_primaryContainer"},i.a.createElement("div",{className:"mx_CreateKeyBackupDialog_passPhraseContainer"},i.a.createElement("div",null,i.a.createElement("input",{type:"password",onChange:this._onPassPhraseConfirmChange,value:this.state.passPhraseConfirm,className:"mx_CreateKeyBackupDialog_passPhraseInput",placeholder:Object(m.a)("Repeat your Security Phrase..."),autoFocus:!0})),s)),i.a.createElement(r,{primaryButton:Object(m.a)("Next"),onPrimaryButtonClick:this._onPassPhraseConfirmNextClick,hasCancel:!1,disabled:this.state.passPhrase!==this.state.passPhraseConfirm}))}_renderPhaseShowKey(){return i.a.createElement("div",null,i.a.createElement("p",null,Object(m.a)("Your Security Key is a safety net - you can use it to restore access to your encrypted messages if you forget your Security Phrase.")),i.a.createElement("p",null,Object(m.a)("Keep a copy of it somewhere secure, like a password manager or even a safe.")),i.a.createElement("div",{className:"mx_CreateKeyBackupDialog_primaryContainer"},i.a.createElement("div",{className:"mx_CreateKeyBackupDialog_recoveryKeyHeader"},Object(m.a)("Your Security Key")),i.a.createElement("div",{className:"mx_CreateKeyBackupDialog_recoveryKeyContainer"},i.a.createElement("div",{className:"mx_CreateKeyBackupDialog_recoveryKey"},i.a.createElement("code",{ref:this._collectRecoveryKeyNode},this._keyBackupInfo.recovery_key)),i.a.createElement("div",{className:"mx_CreateKeyBackupDialog_recoveryKeyButtons"},i.a.createElement("button",{className:"mx_Dialog_primary",onClick:this._onCopyClick},Object(m.a)("Copy")),i.a.createElement("button",{className:"mx_Dialog_primary",onClick:this._onDownloadClick},Object(m.a)("Download"))))))}_renderPhaseKeepItSafe(){let e;this.state.copied?e=Object(m.a)("Your Security Key has been <b>copied to your clipboard</b>, paste it to:",{},{b:e=>i.a.createElement("b",null,e)}):this.state.downloaded&&(e=Object(m.a)("Your Security Key is in your <b>Downloads</b> folder.",{},{b:e=>i.a.createElement("b",null,e)}));const t=l.getComponent("views.elements.DialogButtons");return i.a.createElement("div",null,e,i.a.createElement("ul",null,i.a.createElement("li",null,Object(m.a)("<b>Print it</b> and store it somewhere safe",{},{b:e=>i.a.createElement("b",null,e)})),i.a.createElement("li",null,Object(m.a)("<b>Save it</b> on a USB key or backup drive",{},{b:e=>i.a.createElement("b",null,e)})),i.a.createElement("li",null,Object(m.a)("<b>Copy it</b> to your personal cloud storage",{},{b:e=>i.a.createElement("b",null,e)}))),i.a.createElement(t,{primaryButton:Object(m.a)("Continue"),onPrimaryButtonClick:this._createBackup,hasCancel:!1},i.a.createElement("button",{onClick:this._onKeepItSafeBackClick},Object(m.a)("Back"))))}_renderBusyPhase(e){const t=l.getComponent("views.elements.Spinner");return i.a.createElement("div",null,i.a.createElement(t,null))}_renderPhaseDone(){const e=l.getComponent("views.elements.DialogButtons");return i.a.createElement("div",null,i.a.createElement("p",null,Object(m.a)("Your keys are being backed up (the first backup could take a few minutes).")),i.a.createElement(e,{primaryButton:Object(m.a)("OK"),onPrimaryButtonClick:this._onDone,hasCancel:!1}))}_renderPhaseOptOutConfirm(){const e=l.getComponent("views.elements.DialogButtons");return i.a.createElement("div",null,Object(m.a)("Without setting up Secure Message Recovery, you won't be able to restore your encrypted message history if you log out or use another session."),i.a.createElement(e,{primaryButton:Object(m.a)("Set up Secure Message Recovery"),onPrimaryButtonClick:this._onSetUpClick,hasCancel:!1},i.a.createElement("button",{onClick:this._onCancel},"I understand, continue without")))}_titleForPhase(e){switch(e){case _:return Object(m.a)("Secure your backup with a Security Phrase");case 1:return Object(m.a)("Confirm your Security Phrase");case 6:return Object(m.a)("Warning!");case 2:case 3:return Object(m.a)("Make a copy of your Security Key");case 4:return Object(m.a)("Starting backup...");case C:return Object(m.a)("Success!");default:return Object(m.a)("Create key backup")}}render(){const e=l.getComponent("views.dialogs.BaseDialog");let t;if(this.state.error){const e=l.getComponent("views.elements.DialogButtons");t=i.a.createElement("div",null,i.a.createElement("p",null,Object(m.a)("Unable to create key backup")),i.a.createElement("div",{className:"mx_Dialog_buttons"},i.a.createElement(e,{primaryButton:Object(m.a)("Retry"),onPrimaryButtonClick:this._createBackup,hasCancel:!0,onCancel:this._onCancel})))}else switch(this.state.phase){case _:t=this._renderPhasePassPhrase();break;case 1:t=this._renderPhasePassPhraseConfirm();break;case 2:t=this._renderPhaseShowKey();break;case 3:t=this._renderPhaseKeepItSafe();break;case 4:t=this._renderBusyPhase();break;case C:t=this._renderPhaseDone();break;case 6:t=this._renderPhaseOptOutConfirm()}return i.a.createElement(e,{className:"mx_CreateKeyBackupDialog",onFinished:this.props.onFinished,title:this._titleForPhase(this.state.phase),hasCancel:[_,C].includes(this.state.phase)},i.a.createElement("div",null,t))}}r()(P,"propTypes",{onFinished:p.a.func.isRequired})}}]);
//# sourceMappingURL=5.js.map